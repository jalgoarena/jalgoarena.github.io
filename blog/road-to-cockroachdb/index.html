<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta name="generator" content="Hugo 0.44" />
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Road to Cockroach DB </title>

  
  <meta name="description" content="How to scale your persistence keeping microservices design"> 
  
  
  
  
  

  

  <meta name="author" content="JAlgoArena">


  <meta property="og:title" content="Road to Cockroach DB" />
<meta property="og:description" content="How to scale your persistence keeping microservices design" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jalgoarena.github.io/blog/road-to-cockroachdb/" />



<meta property="article:published_time" content="2018-08-07T06:26:36&#43;02:00"/>

<meta property="article:modified_time" content="2018-08-07T06:26:36&#43;02:00"/>











  




  
  
  
  
  

  <link rel="canonical" href="https://jalgoarena.github.io/blog/road-to-cockroachdb/">  

  <link rel="shortcut icon" type="image/png" href="/img/favicons/favicon.ico">


  <link href="/css/font.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.min.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.legenda.css" rel="stylesheet" type="text/css">
  <link href="/css/highlight.css" rel="stylesheet" type="text/css">
  <link href="/css/master.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.demo.css" rel="stylesheet" type="text/css">

 <link href="/css/custom.css" rel="stylesheet" type="text/css">

  <script src="/js/jquery-2.1.4.min.js" type="text/javascript">
  </script>

  <script type="text/javascript" src="/js/tocbot.min.js"></script>
</head>


<body class="page-kube">
  <header> <div class="show-sm">
    <div id="nav-toggle-box">
      <div id="nav-toggle-brand">
        <a href="/">JAlgoArena Home</a>
      </div><a data-component="toggleme" data-target="#top" href="#" id="nav-toggle"><i class="kube-menu"></i></a>
    </div>
  </div>
  <div class="hide-sm" id="top">
    <div id="top-brand">
      <a href="/" title="home"><img alt="Baseline" src="/img/common/logx2.png" width="120"></a>
    </div>
    <nav id="top-nav-main">
      <ul>
       
       
    <li><a href="/blog/" >Blog</a></li>
    
    <li><a href="/docs/" >Docs</a></li>
    
    <li><a href="/faq/" >Faq</a></li>
    
      </ul>
    </nav>
    <nav id="top-nav-extra"> 
      <ul>
          
      </ul>
    </nav>
  </div>
 </header>
  <main>
<div class="push-center" itemscope itemtype="http://schema.org/BlogPosting">
    
<meta itemprop="name" content="Road to Cockroach DB">
<meta itemprop="description" content="How to scale your persistence keeping microservices design">


<meta itemprop="datePublished" content="2018-08-07T06:26:36&#43;02:00" />
<meta itemprop="dateModified" content="2018-08-07T06:26:36&#43;02:00" />
<meta itemprop="wordCount" content="1275">



<meta itemprop="keywords" content="" />

<div id="hero">
    <h2 itemprop="headline">  Road to Cockroach DB</h2>
    
<blockquote itemprop="description">How to scale your persistence keeping microservices design</blockquote>

<time class="post-time"><span class="icon">
  <i class="fa fa-clock-o" aria-hidden="true"></i>
</span>
<span>6 minute read</span>
<span class="icon">
 <i class="fa fa-pencil" aria-hidden="true"></i>
</span>

  Published: <time datetime="2018-08-07T06:26:36&#43;02:00">7 Aug, 2018</time>

</time>
</div>
<div id="post-box">
<div id="post" itemprop="articleBody">
    
    <h3 class="section-head" id="h-intro"><a href="#h-intro">Intro</a></h3>

<p>To fully understand all words used across article - please refer to <a href="https://jalgoarena.github.io/docs/domain/">domain page</a>.</p>

<h3 class="section-head" id="h-databases-microservices"><a href="#h-databases-microservices">Databases in microservices world</a></h3>

<p>Databases &hellip; yes databases. In new microservice architecture world so much impact is put on serverless or function style
components, where stateless code wins. And obviously that&rsquo;s a great idea, when you have no state you have no need to synchronize
nor to lock. Scaling is the matter of replication and understanding of flow is obvious in a immutable world.</p>

<p>But still - can you imagine product bringing business value which does not handle state? Let&rsquo;s imagine identity management -
this always will require to store some user info. Some may say but you know, there is google, github, and other OAuth which
handles that for you - sure but it simply means you are using external service to store the data - still you need somewhere
db to exist.</p>

<p>Anyway, let&rsquo;s go back to <strong>JAlgoArena</strong> world. In this post I would like you to show how I dealt through months with data
and how different problems moved me to different solutions.</p>

<h3 class="section-head" id="h-simple"><a href="#h-simple">On the beginning it's simple, is it?</a></h3>

<p>When I started first prototype of <strong>JAlgoArena</strong> there was no separate storage tool, and design was very simple:</p>

<p><img src="https://raw.githubusercontent.com/jalgoarena/JAlgoArena/4e141f19b47ad7be100c96112059ebd88e7532ec/design/component_diagram.png" alt="Initial Design" /></p>

<p>State was there, but it was just hardcoded within Judge microservice. Not very useful for production use case, right?</p>

<p>That was the time when I started to think what should I choose, and how it should look like. By whole the time I had in my mind
the pattern that every microservice should have own database - and by the best efforts it should not be shared.</p>

<p>Ok, I had already experience with <strong>Mongo DB</strong> and I loved how it managed state. Although I wanted more embedded approach,
when I can keep database really close to microservices. Lets see my first approach to real world storage handling:</p>

<p><img src="https://raw.githubusercontent.com/jalgoarena/JAlgoArena/e13a8b73c0fa2bc60284e3b4deb76c453d0a2119/design/component_diagram.png" alt="First approach" /></p>

<p>Great - in here I was not yet great with all <strong>DDD</strong> approaches and domain separation, so please excuse me ;) My initial
understanding of database per microservices moved me to idea - so let&rsquo;s do a microservice with a responsibility for dealing
with a data (I know, I know &hellip; it was not best idea)!</p>

<p>As my research went, I found <a href="https://github.com/louischatriot/nedb">NeDB</a> as a great solution, I had my brand new NodeJS microservice
and could deal with data there. In reality - as you see on diagram I used json file for handling problems data - so <strong>NeDB</strong> wasn&rsquo;t my only choice.</p>

<p>The solution was pretty easy, you could save incoming json and then query for it (you can still check it on GitHub <a href="https://github.com/spolnik/JAlgoArena-Data-Obsoleted">page</a>).
I was creating new file based storage for both contexts: users and submissions to keep them separate. By the way - it was first sign of
keeping two responsibilities within single service. Creating database was fairly easy, there was
<a href="https://github.com/spolnik/JAlgoArena-Data-Obsoleted/blob/master/server/newLocalDb.js">simple code</a> to create it:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Datastore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nedb&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">logger</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Datastore</span><span class="p">({</span><span class="nx">filename</span><span class="o">:</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">autoload</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">loadDatabase</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&#34;DB loaded: &#34;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>Querying submissions looked like:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">submissionDb</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">userId</span><span class="o">:</span> <span class="nx">newSubmission</span><span class="p">.</span><span class="nx">userId</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<p>All database operations you can find in <a href="https://github.com/spolnik/JAlgoArena-Data-Obsoleted/blob/master/server/routes/submission.js">submissions.js</a>,
and all users ones in <a href="https://github.com/spolnik/JAlgoArena-Data-Obsoleted/blob/master/server/config/passport.js">passport.js</a>.</p>

<p>By the way, another insight I would have on below was that database code was coupled with business logic - which in reality should be handled by some repositories.</p>

<p>As you see above, it was a bit better (finally we have real storage!) approach, but far from being ideal and we did not touch even scalability issues.</p>

<p>Oh &hellip; one more point. At that time it was when I decided keeping problems within json was not a good idea. You know, we need <strong>the</strong> database ;)</p>

<p><img src="https://github.com/jalgoarena/JAlgoArena/raw/d94f858e259a5cfdc514a3b0ce0ca9f94996ee56/design/component_diagram.png" alt="All within db" /></p>

<p>Interestingly, at some of current versions I&rsquo;ve reverted that approached and went back for json - as it&rsquo;s best serving this kind of data - and that&rsquo;s what I love
about microservices. Keeping them small and decoupled allows on quick and easy changes, even rewrite of whole service when needed :)</p>

<h3 class="section-head" id="h-db-per-microservice"><a href="#h-db-per-microservice">Database per microservice</a></h3>

<p>Ok, my whole soul, mind and body was fulfilled with the idea - keep database specific to microservice. And again, I wanted to use something which can sit together
with microservice - use some kind of embedded database and make usage of it as simple as possible. Oh - and I wanted to switch to <a href="https://spring.io/projects/spring-boot">Spring Boot</a>
which is de facto widely standard within Java ecosystem for creating microservices.</p>

<p>I looked for quite a while, compared different approaches and finally found - [Xodus](). However badly the name sounds, it&rsquo;s pretty decent database created by <strong>JetBrains</strong>.
<strong>JetBrains Xodus</strong> is a Java transactional schema-less embedded database - and they use it for own products e.g. <strong>JetBrains YouTrack</strong>.
You may read more about it in <a href="https://github.com/JetBrains/xodus/wiki">here</a>. Just to be clear, it&rsquo;s not a kindergarten tool,
it is serious database capable to handle terabytes of data having transactions on board.</p>

<p>Let&rsquo;s see how it impacted the architecture:</p>

<p><img src="https://github.com/jalgoarena/JAlgoArena/raw/e9cc7ec915018ff154cb01f0246d5154ee77e89b/design/component_diagram.png" alt="Xodus based solution" /></p>

<p>Besides of the fact that whole architecture grew to use <strong>Service Discovery</strong> approach, now you can see every microservice own
separate database. Let&rsquo;s see how some of the repository methods are implemented within <strong>Kotlin</strong> using Xodus:</p>

<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">findAll</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Problem</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">readonly</span> <span class="p">{</span>
        <span class="n">it</span><span class="p">.</span><span class="n">getAll</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">ENTITY_TYPE</span><span class="p">).</span><span class="n">map</span> <span class="p">{</span> <span class="n">Problem</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>There is bit of <strong>Kotlin</strong> know how to decrypt it - but it&rsquo;s enough to understand that <strong>it</strong> is a thing passed from readonly
method, which looks like:</p>

<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="k">fun</span> &lt;T&gt; <span class="nf">readonly</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="p">(</span><span class="n">PersistentStoreTransaction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">store</span><span class="p">.</span><span class="n">computeInReadonlyTransaction</span> <span class="p">{</span> <span class="n">call</span><span class="p">(</span><span class="n">it</span> <span class="k">as</span> <span class="n">PersistentStoreTransaction</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>As you see, it&rsquo;s just wrapping the code into readonly transaction (btw, such structures is why I love <strong>Kotlin</strong>) and passing store
down to method, where we invoke getAll describing our entity name, and finally using <strong>Kotlin</strong> streams to map outgoing problems.</p>

<p>To make a full picture, let&rsquo;s see how write transaction looks like:
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="k">fun</span> &lt;T&gt; <span class="nf">transactional</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="p">(</span><span class="n">PersistentStoreTransaction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">store</span><span class="p">.</span><span class="n">computeInTransaction</span> <span class="p">{</span> <span class="n">call</span><span class="p">(</span><span class="n">it</span> <span class="k">as</span> <span class="n">PersistentStoreTransaction</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span></code></pre></div></p>

<p>And then how it is used to update existing items:</p>

<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">override</span> <span class="k">fun</span> <span class="nf">addOrUpdate</span><span class="p">(</span><span class="n">problem</span><span class="p">:</span> <span class="n">Problem</span><span class="p">):</span> <span class="n">Problem</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">transactional</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">existingEntity</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">Constants</span><span class="p">.</span><span class="n">ENTITY_TYPE</span><span class="p">,</span> <span class="n">Constants</span><span class="p">.</span><span class="n">problemId</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">id</span>
        <span class="p">).</span><span class="n">firstOrNull</span><span class="p">()</span>
        <span class="k">val</span> <span class="py">entity</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">existingEntity</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">null</span> <span class="p">-&gt;</span> <span class="n">it</span><span class="p">.</span><span class="n">newEntity</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">ENTITY_TYPE</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">existingEntity</span>
        <span class="p">}</span>
        <span class="n">updateEntity</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">problem</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">updateEntity</span><span class="p">(</span><span class="n">entity</span><span class="p">:</span> <span class="n">Entity</span><span class="p">,</span> <span class="n">problem</span><span class="p">:</span> <span class="n">Problem</span><span class="p">):</span> <span class="n">Problem</span> <span class="p">{</span>
    <span class="n">entity</span><span class="p">.</span><span class="n">apply</span> <span class="p">{</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemId</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemTitle</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemDescription</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemLevel</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">level</span><span class="p">)</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemTimeLimit</span><span class="p">,</span> <span class="n">problem</span><span class="p">.</span><span class="n">timeLimit</span><span class="p">)</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemFunction</span><span class="p">,</span> <span class="n">toJson</span><span class="p">(</span><span class="n">problem</span><span class="p">.</span><span class="n">func</span><span class="o">!!</span><span class="p">))</span>
        <span class="n">setProperty</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">problemTestCases</span><span class="p">,</span> <span class="n">toJson</span><span class="p">(</span><span class="n">problem</span><span class="p">.</span><span class="n">testCases</span><span class="o">!!</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Problem</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>Full source code is available in here - <a href="https://github.com/spolnik/JAlgoArena-Problems/blob/master/src/main/kotlin/com/jalgoarena/data/XodusProblemsRepository.kt">XodusProblemRepository.kt</a>.</p>

<p>This approach worked for quite a while - and I run few AlgoCup contest using it in production environment without any issues, or closely without any issues ;)</p>

<p>The biggest challenge was, that any single component which was using it was hard to scale horizontally. If I start replicating services,
how do I synchronize those file based storages?</p>

<p>And there was actually partial rescue:</p>

<p><img src="https://github.com/jalgoarena/JAlgoArena/raw/900a3cb2df2eadfac11133a3932a3ecd0f9bc406/design/component_diagram.png" alt="Apache Kafka for rescue" /></p>

<p>That was huge change for a platform - making it reactive with all the writes (besides of creating accounts). That allowed
to keep data log with Kafka, and replicate as many instances of Ranking or Submissions services as we want. But &hellip; there
is always some but ;)</p>

<p>Authentication was not coming through Apache Kafka. Till security is introduced within <strong>JAlgoArena</strong> on Apache Kafka level,
I cannot imagine keeping there user names and passwords and recover from it ;) The only choice is to still use synchronous
approach - so we cannot scale in here with <strong>Xodus</strong> database - we need scalable storage by itself and it&rsquo;s hard to achieve
with embedded storage.</p>

<h3 class="section-head" id="h-cockroach"><a href="#h-cockroach">Scalability matters - Cockroach DB coming</a></h3>

<p>TBC</p>


</div>

    <div class="">
        <p>
  Published
  
    
      by <span itemprop="author">JAlgoArena</span>
    
  
  <time datetime="2018-08-07T06:26:36&#43;02:00">
    7 Aug, 2018
  </time>
  
    in <span itemprop="articleSection"><a href="/categories/db/">db</a> and <a href="/categories/general/">general</a></span>
  
  
  using <span itemprop="wordCount">1275</span> words.
</p>

        



    </div>
    
    
    
</div>
</div>
</main>
  <footer>   <footer id="footer">
    <nav>
      <ul>
        <li><span>JAlgoArena</span></li>
        <li>
          <a href="/company/">Author</a>
        </li>
        <li>
          <a href="/blog/">Blog</a>
        </li>
          <li>
          <a href="/docs/">Docs</a>
        </li>
        <li>
          <a href="https://twitter.com/jacek_spolnik">Give a shout-out on Twitter!</a>
        </li>
      </ul>
    </nav>
    <p>&copy; Licence Apache 2.0</p>
  </footer> </footer>


  <script src="/js/kube.js" type="text/javascript">
  </script>
  <script src="/js/kube.legenda.js" type="text/javascript">
  </script>
  <script src="/js/master.js" type="text/javascript">
  </script>
</body>

</html>
